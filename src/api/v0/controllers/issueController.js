
// =============================================================================
// src/controllers/issueController.js - Contrôleur IssueReport (6 endpoints)
// =============================================================================
const ProxyService = require('../../../services/proxyHandler');



// Middleware de validation pour les requêtes proxy
function validateProxyInput(req, res, next) {
  const { body, query, params } = req;
  
  // Validation basique des inputs
  const allInputs = { ...body, ...query, ...params };
  
  for (const [key, value] of Object.entries(allInputs)) {
    if (typeof value === 'string') {
      // Vérifier les patterns dangereux
      const dangerousPatterns = [
        /<script[^>]*>.*?<\/script>/gi,
        /javascript:/gi,
        /on\w+\s*=/gi,
        /('|(\-\-)|;|\||\*|%|=)/gi
      ];
      
      for (const pattern of dangerousPatterns) {
        if (pattern.test(value)) {
          return res.status(400).json({
            error: 'Invalid input detected',
            message: 'Request contains potentially dangerous content'
          });
        }
      }
      
      // Limiter la taille des inputs
      if (value.length > 1000) {
        return res.status(400).json({
          error: 'Input too large',
          message: 'Individual input fields cannot exceed 1000 characters'
        });
      }
    }
  }
  
  next();
}

class IssueController {
  // GET /IssueReport - Gets all Issues Reported
  async getIssueReports(req, res) {
    // Validation d'input
    const validation = validateProxyInput(req, res, () => {});
    if (validation) return validation;
    
   
    await ProxyService.proxyToMonty(req, res, '/IssueReport');
  }

  // POST /IssueReport - Submit an Issue Report
  async addIssueReport(req, res) {
    // Validation d'input
    const validation = validateProxyInput(req, res, () => {});
    if (validation) return validation;
    
   
    await ProxyService.proxyToMonty(req, res, '/IssueReport');
  }

  // DELETE /IssueReport/{ReportID} - Delete IssueReport
  async deleteIssueReport(req, res) {
    // Validation d'input
    const validation = validateProxyInput(req, res, () => {});
    if (validation) return validation;
    
   
    await ProxyService.proxyToMonty(req, res, `/IssueReport/${req.params.ReportID}`);
  }

  // PUT /IssueReport/{ReportID} - Modify Issue Report
  async editIssueReport(req, res) {
    // Validation d'input
    const validation = validateProxyInput(req, res, () => {});
    if (validation) return validation;
    
   
    await ProxyService.proxyToMonty(req, res, `/IssueReport/${req.params.ReportID}`);
  }

  // PUT /IssueReport/{ReportID}/Feedback - Submit Feedback for Issue
  async submitFeedback(req, res) {
    // Validation d'input
    const validation = validateProxyInput(req, res, () => {});
    if (validation) return validation;
    
   
    await ProxyService.proxyToMonty(req, res, `/IssueReport/${req.params.ReportID}/Feedback`);
  }

  // PUT /ResolveIssue/{ReportID} - Resolve an Issue Report
  async resolveIssue(req, res) {
    // Validation d'input
    const validation = validateProxyInput(req, res, () => {});
    if (validation) return validation;
    
   
    await ProxyService.proxyToMonty(req, res, `/ResolveIssue/${req.params.ReportID}`);
  }
}

module.exports = new IssueController();
